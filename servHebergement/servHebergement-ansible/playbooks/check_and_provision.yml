---
- name: Check hosts and provision if needed
  hosts: localhost
  gather_facts: false
  vars:
    disk_thereshold: 80
    containers_thereshold: 10
    service_request_id: "{{ service_request_id | default('req-123') }}"
    service_type: "{{ service_type | default('minecraft') }}"
    service_user: "{{ service_user | default('user') }}"

  tasks:
    - name: Gather disk usage from all hosts
      ansible.builtin.shell: df -h --output=pcent / | tail -n1 | tr -dc '0-9'
      register: disk_usage
      delegate_to: "{{ item }}"
      loop: "{{ groups['hosts_pool'] }}"
      ignore_errors: true

    - name: Gather container count
      community.docker.docker_host_info:
      delegate_to: "{{ item }}"
      loop: "{{ groups['hosts_pool'] }}"
      register: docker_info
      ignore_errors: true

    - name: Decide if new host is needed
      set_fact:
        need_new_host: >-
          {{
            (disk_usage.results | map(attribute='stdout') | map('int') | list | max | default(0) >= disk_thereshold)
            or (docker_info.results | map(attribute='docker_info.Containers') | list | max | default(0) >= containers_thereshold)
            or (groups['hosts_pool'] | length == 0)
          }}

    - name: Provision new VM if needed
      include_role:
        name: vm_provision
      when: need_new_host

    - name: Deploy requested service
      include_role:
        name: deploy_service
      vars:
        service_request_id: "{{ service_request_id }}"
        service_type: "{{ service_type }}"
        service_user: "{{ service_user }}"
